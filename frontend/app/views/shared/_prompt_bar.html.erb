<%# Prompt Bar - Midjourney-style centered input %>
<%# Rendered in layout header area for authenticated users %>

<% header_pending_count = current_user.images.where(status: ['pending', 'processing']).count %>
<% processing_image = current_user.images.find_by(status: 'processing') %>

<header class="sticky top-0 z-40 border-b" style="background-color: hsl(var(--card)); border-color: hsl(var(--border));">
  <%# Queue Status Bar - Shows when generating %>
  <% if header_pending_count > 0 %>
    <div class="queue-status-bar px-4 py-2 border-b flex items-center justify-center gap-3" style="background-color: hsl(var(--muted) / 0.5); border-color: hsl(var(--border));">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--primary));">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="text-xs font-medium" style="color: hsl(var(--foreground));">
          <% if processing_image %>
            Generating <%= header_pending_count > 1 ? "1 of #{header_pending_count}" : "" %>
          <% else %>
            <%= header_pending_count %> in queue
          <% end %>
        </span>
      </div>

      <%# Mini progress bar %>
      <div class="w-24 h-1.5 rounded-full overflow-hidden" style="background-color: hsl(var(--muted));">
        <div id="header-progress-bar" class="h-full rounded-full transition-all duration-500" style="background-color: hsl(var(--primary)); width: 5%;"></div>
      </div>

      <% if processing_image %>
        <span class="text-[10px] truncate max-w-[150px]" style="color: hsl(var(--muted-foreground));">
          "<%= processing_image.prompt&.truncate(25) %>"
        </span>
      <% end %>
    </div>
  <% end %>

  <div class="px-4 py-4">
    <%= form_with model: Image.new, url: images_path, method: :post, multipart: true, data: { turbo: false }, class: "flex items-center gap-4 max-w-3xl mx-auto", id: "generate-form" do |f| %>

      <%# Mode Toggle (Text/Image) - Pill style %>
      <div class="mode-toggle flex flex-shrink-0 rounded-full overflow-hidden" style="background-color: hsl(var(--muted));">
        <label class="cursor-pointer">
          <input type="radio" name="generation_mode" value="text_to_image" checked class="peer sr-only" onchange="toggleMode()">
          <span class="mode-toggle-option block transition-all peer-checked:bg-[hsl(var(--primary))] peer-checked:text-white peer-checked:shadow-sm" style="color: hsl(var(--muted-foreground));">Text</span>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="generation_mode" value="image_to_image" class="peer sr-only" onchange="toggleMode()">
          <span class="mode-toggle-option block transition-all peer-checked:bg-[hsl(var(--primary))] peer-checked:text-white peer-checked:shadow-sm" style="color: hsl(var(--muted-foreground));">Image</span>
        </label>
      </div>

      <%# Main Prompt Input - Larger pill with glow on focus %>
      <div class="flex-1 relative group">
        <div class="prompt-input-container flex items-center gap-3 px-5 py-3 rounded-full border transition-all duration-200"
             style="background-color: hsl(var(--background)); border-color: hsl(var(--border));">

          <%# Sparkle icon - animates on focus %>
          <svg class="w-5 h-5 flex-shrink-0 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--muted-foreground));">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
          </svg>

          <%= f.text_field :prompt,
              id: "prompt-input",
              placeholder: "What will you create today?",
              required: true,
              autocomplete: "off",
              class: "flex-1 bg-transparent border-0 outline-none text-base",
              style: "color: hsl(var(--foreground));",
              oninput: "updateTokenCount()",
              data: { action: "keydown->prompt#handleKeydown" } %>

          <%# Token Counter - shows token usage against CLIP limit %>
          <span id="token-counter" class="flex items-center gap-1 text-xs whitespace-nowrap token-counter-green" style="color: hsl(var(--muted-foreground));">
            <span id="token-count">0</span>/77
          </span>

          <%# Keyboard shortcut hint - shows when empty %>
          <span id="shortcut-hint" class="hidden sm:flex items-center gap-1 text-xs whitespace-nowrap" style="color: hsl(var(--muted-foreground));">
            <kbd class="px-1.5 py-0.5 rounded text-xs font-mono" style="background-color: hsl(var(--muted));">⌘</kbd>
            <kbd class="px-1.5 py-0.5 rounded text-xs font-mono" style="background-color: hsl(var(--muted));">↵</kbd>
          </span>

          <%# Keyboard shortcuts button %>
          <button type="button" onclick="toggleShortcutsModal()" class="p-1.5 rounded-full transition-colors hover:bg-white/10 hidden sm:block" title="Keyboard shortcuts (?)" aria-label="View keyboard shortcuts">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--muted-foreground));" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </button>

          <%# Improve Prompt button %>
          <button type="button" onclick="improvePrompt()" id="improve-btn" class="hidden sm:flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors hover:bg-white/10" title="Enhance prompt with quality keywords" aria-label="Improve prompt" style="color: hsl(var(--primary));">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
            <span>Improve</span>
          </button>

          <%# Settings toggle %>
          <button type="button" onclick="toggleSettings()" class="p-1.5 rounded-full transition-colors hover:bg-white/10" title="Generation Settings (S)" aria-label="Open generation settings">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--muted-foreground));" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
            </svg>
          </button>
        </div>
      </div>

      <%# Generate Button - Larger, more prominent %>
      <%= f.submit "Generate",
          id: "generate-btn",
          disabled: !current_user.can_generate?,
          class: "dw-btn dw-btn-primary dw-btn-lg dw-glow-cyan #{current_user.can_generate? ? '' : 'opacity-50 cursor-not-allowed'}" %>

      <%# Hidden Inputs for settings %>
      <input type="hidden" name="image[model_key]" id="model_key_input" value="sd-v1-5">
      <input type="hidden" name="image[lora_key]" id="lora_key_input" value="">
      <input type="hidden" name="image[num_inference_steps]" id="steps_input" value="30">
      <input type="hidden" name="image[guidance_scale]" id="guidance_input" value="7.5">
      <input type="hidden" name="image[width]" id="width_input" value="512">
      <input type="hidden" name="image[height]" id="height_input" value="512">
      <input type="hidden" name="image[negative_prompt]" id="negative_prompt_input" value="">
      <input type="hidden" name="image[seed]" id="seed_input" value="">
      <input type="hidden" name="strength" id="strength_input" value="0.3">
    <% end %>

    <%# Prompt Tips & Quick Tags - Inline dropdowns (SD Web style) %>
    <div class="max-w-3xl mx-auto mt-2">
      <div class="flex items-center gap-3">
        <%# Tips dropdown - left side %>
        <div class="tag-dropdown relative">
          <button type="button" onclick="toggleTagDropdown('tips')" class="tag-dropdown-btn flex items-center gap-1.5 px-2 py-1 text-xs rounded-md border transition-colors" style="background-color: hsl(var(--muted)); border-color: hsl(var(--border)); color: hsl(var(--foreground));">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--primary));">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span>Tips</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="dropdown-tips" class="tag-dropdown-menu hidden absolute top-full left-0 mt-1 p-3 rounded-lg border shadow-lg z-50" style="background-color: hsl(var(--card)); border-color: hsl(var(--border)); min-width: 408px;">
            <div class="space-y-1.5 text-xs">
              <div class="flex items-center gap-2 py-1">
                <span class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold" style="background-color: hsl(var(--primary) / 0.2); color: hsl(var(--primary));">1</span>
                <span style="color: hsl(var(--foreground));"><strong>Be specific</strong> — "golden retriever puppy" beats "dog"</span>
              </div>
              <div class="flex items-center gap-2 py-1">
                <span class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold" style="background-color: hsl(var(--primary) / 0.2); color: hsl(var(--primary));">2</span>
                <span style="color: hsl(var(--foreground));"><strong>Include style</strong> — "oil painting", "photograph", "3D render"</span>
              </div>
              <div class="flex items-center gap-2 py-1">
                <span class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold" style="background-color: hsl(var(--primary) / 0.2); color: hsl(var(--primary));">3</span>
                <span style="color: hsl(var(--foreground));"><strong>Add lighting</strong> — "golden hour", "studio lighting", "neon glow"</span>
              </div>
              <div class="flex items-center gap-2 py-1">
                <span class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold" style="background-color: hsl(var(--primary) / 0.2); color: hsl(var(--primary));">4</span>
                <span style="color: hsl(var(--foreground));"><strong>Specify camera</strong> — "close-up", "wide angle", "aerial view"</span>
              </div>
            </div>
            <div class="mt-2 pt-2 border-t text-[11px]" style="border-color: hsl(var(--border)); color: hsl(var(--muted-foreground));">
              <strong style="color: hsl(var(--primary));">Pro tip:</strong> Important elements first — CLIP weights left-to-right.
            </div>
          </div>
        </div>

        <%# Inline tag dropdowns - right side %>
        <div class="flex items-center gap-1.5 ml-auto">
          <%# Lighting dropdown %>
          <div class="tag-dropdown relative">
            <button type="button" onclick="toggleTagDropdown('lighting')" class="tag-dropdown-btn flex items-center gap-1 px-2 py-1 text-xs rounded-md border transition-colors" style="background-color: hsl(var(--muted)); border-color: hsl(var(--border)); color: hsl(var(--foreground));">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
              <span>Lighting</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="dropdown-lighting" class="tag-dropdown-menu hidden absolute top-full right-0 mt-1 p-2 rounded-lg border shadow-lg z-50" style="background-color: hsl(var(--card)); border-color: hsl(var(--border)); min-width: 160px;">
              <button type="button" onclick="addSuggestion('golden hour')" data-term="golden hour" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">golden hour</button>
              <button type="button" onclick="addSuggestion('studio lighting')" data-term="studio lighting" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">studio lighting</button>
              <button type="button" onclick="addSuggestion('dramatic shadows')" data-term="dramatic shadows" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">dramatic shadows</button>
              <button type="button" onclick="addSuggestion('neon glow')" data-term="neon glow" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">neon glow</button>
            </div>
          </div>

          <%# Style dropdown %>
          <div class="tag-dropdown relative">
            <button type="button" onclick="toggleTagDropdown('style')" class="tag-dropdown-btn flex items-center gap-1 px-2 py-1 text-xs rounded-md border transition-colors" style="background-color: hsl(var(--muted)); border-color: hsl(var(--border)); color: hsl(var(--foreground));">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
              <span>Style</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="dropdown-style" class="tag-dropdown-menu hidden absolute top-full right-0 mt-1 p-2 rounded-lg border shadow-lg z-50" style="background-color: hsl(var(--card)); border-color: hsl(var(--border)); min-width: 160px;">
              <button type="button" onclick="addSuggestion('photorealistic')" data-term="photorealistic" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">photorealistic</button>
              <button type="button" onclick="addSuggestion('oil painting')" data-term="oil painting" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">oil painting</button>
              <button type="button" onclick="addSuggestion('watercolor')" data-term="watercolor" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">watercolor</button>
              <button type="button" onclick="addSuggestion('digital art')" data-term="digital art" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">digital art</button>
            </div>
          </div>

          <%# Quality dropdown %>
          <div class="tag-dropdown relative">
            <button type="button" onclick="toggleTagDropdown('quality')" class="tag-dropdown-btn flex items-center gap-1 px-2 py-1 text-xs rounded-md border transition-colors" style="background-color: hsl(var(--muted)); border-color: hsl(var(--border)); color: hsl(var(--foreground));">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
              <span>Quality</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="dropdown-quality" class="tag-dropdown-menu hidden absolute top-full right-0 mt-1 p-2 rounded-lg border shadow-lg z-50" style="background-color: hsl(var(--card)); border-color: hsl(var(--border)); min-width: 160px;">
              <button type="button" onclick="addSuggestion('highly detailed')" data-term="highly detailed" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">highly detailed</button>
              <button type="button" onclick="addSuggestion('8k resolution')" data-term="8k resolution" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">8k resolution</button>
              <button type="button" onclick="addSuggestion('sharp focus')" data-term="sharp focus" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">sharp focus</button>
            </div>
          </div>

          <%# Camera dropdown %>
          <div class="tag-dropdown relative">
            <button type="button" onclick="toggleTagDropdown('camera')" class="tag-dropdown-btn flex items-center gap-1 px-2 py-1 text-xs rounded-md border transition-colors" style="background-color: hsl(var(--muted)); border-color: hsl(var(--border)); color: hsl(var(--foreground));">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
              <span>Camera</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="dropdown-camera" class="tag-dropdown-menu hidden absolute top-full right-0 mt-1 p-2 rounded-lg border shadow-lg z-50" style="background-color: hsl(var(--card)); border-color: hsl(var(--border)); min-width: 160px;">
              <button type="button" onclick="addSuggestion('close-up')" data-term="close-up" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">close-up</button>
              <button type="button" onclick="addSuggestion('wide angle')" data-term="wide angle" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">wide angle</button>
              <button type="button" onclick="addSuggestion('aerial view')" data-term="aerial view" class="suggestion-chip block w-full px-3 py-2 text-xs rounded hover:bg-white/10 transition-colors whitespace-nowrap" style="color: hsl(var(--foreground)); text-align: left;">aerial view</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</header>

<style>
  /* Mode Toggle - Design System Styling */
  .mode-toggle {
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .mode-toggle-option {
    padding: 0.5rem 1rem;
    min-height: 2.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }

  /* Focus state for prompt input container */
  .prompt-input-container:focus-within {
    border-color: hsl(var(--primary)) !important;
    box-shadow: 0 0 0 3px hsl(var(--primary) / 0.15), 0 0 20px hsl(var(--primary) / 0.1);
  }

  .prompt-input-container:focus-within svg:first-child {
    color: hsl(var(--primary)) !important;
  }

  /* Hide shortcut hint when input has value */
  #prompt-input:not(:placeholder-shown) ~ #shortcut-hint {
    display: none !important;
  }

  /* Token counter color states */
  .token-counter-green { color: hsl(142 76% 36%) !important; }
  .token-counter-yellow { color: hsl(45 93% 47%) !important; }
  .token-counter-red { color: hsl(0 84% 60%) !important; }

  /* Tag dropdown styles */
  .tag-dropdown-btn:hover {
    filter: brightness(1.1);
    border-color: hsl(var(--primary) / 0.5) !important;
  }

  .tag-dropdown-btn.active {
    border-color: hsl(var(--primary)) !important;
    background-color: hsl(var(--primary) / 0.1) !important;
  }

  .tag-dropdown-menu {
    animation: dropdownSlide 0.15s ease-out;
  }

  @keyframes dropdownSlide {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Subtle pulse on generate button when ready */
  @keyframes ready-pulse {
    0%, 100% { box-shadow: 0 0 20px hsl(var(--primary) / 0.3); }
    50% { box-shadow: 0 0 25px hsl(var(--primary) / 0.5); }
  }

  #generate-btn:not(:disabled):hover {
    animation: ready-pulse 1.5s ease-in-out infinite;
  }

  /* Queue progress bar - now controlled by JS polling */
  #header-progress-bar {
    transition: width 0.5s ease-out;
  }

  /* Queue status bar subtle gradient */
  .queue-status-bar {
    background: linear-gradient(90deg,
      hsl(var(--muted) / 0.3) 0%,
      hsl(var(--primary) / 0.1) 50%,
      hsl(var(--muted) / 0.3) 100%
    );
    background-size: 200% 100%;
    animation: queue-gradient 3s ease-in-out infinite;
  }

  @keyframes queue-gradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  /* Suggestion chips - Command Center aesthetic */
  .suggestion-chip {
    position: relative;
    cursor: pointer;
    user-select: none;
  }

  .suggestion-chip:hover {
    filter: brightness(1.1);
    border-color: hsl(var(--primary) / 0.5) !important;
  }

  .suggestion-chip.active {
    background-color: hsl(var(--primary) / 0.15) !important;
    border-color: hsl(var(--primary) / 0.5) !important;
    color: hsl(var(--primary)) !important;
  }

  .suggestion-chip.active::before {
    content: "✓ ";
    font-weight: bold;
    margin-right: 2px;
  }
</style>

<script>
  // Token counter - estimates CLIP token count from word count
  // CLIP uses BPE tokenizer, roughly 1.3 tokens per word on average
  function updateTokenCount() {
    const promptInput = document.getElementById('prompt-input');
    const tokenCountEl = document.getElementById('token-count');
    const tokenCounterEl = document.getElementById('token-counter');

    if (!promptInput || !tokenCountEl || !tokenCounterEl) return;

    const text = promptInput.value.trim();
    const wordCount = text ? text.split(/\s+/).length : 0;
    const estimatedTokens = Math.ceil(wordCount * 1.3);

    tokenCountEl.textContent = estimatedTokens;

    // Update color based on token count
    tokenCounterEl.classList.remove('token-counter-green', 'token-counter-yellow', 'token-counter-red');

    if (estimatedTokens > 75) {
      tokenCounterEl.classList.add('token-counter-red');
      tokenCounterEl.title = 'Prompt may be truncated (77 token limit)';
    } else if (estimatedTokens > 60) {
      tokenCounterEl.classList.add('token-counter-yellow');
      tokenCounterEl.title = 'Approaching token limit';
    } else {
      tokenCounterEl.classList.add('token-counter-green');
      tokenCounterEl.title = 'Token count OK';
    }

    // Update chip states when prompt changes
    updateChipStates();
  }

  // Add suggestion to prompt
  function addSuggestion(term) {
    const promptInput = document.getElementById('prompt-input');
    if (!promptInput) return;

    const currentPrompt = promptInput.value.trim();

    // Check if term already exists (case-insensitive)
    const promptLower = currentPrompt.toLowerCase();
    const termLower = term.toLowerCase();

    if (promptLower.includes(termLower)) {
      // Term already in prompt, don't add again
      if (typeof showInfoToast === 'function') {
        showInfoToast('Already Added', `"${term}" is already in your prompt`);
      }
      // Close dropdown anyway
      document.querySelectorAll('.tag-dropdown-menu').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.tag-dropdown-btn').forEach(b => b.classList.remove('active'));
      return;
    }

    // Add term with comma separator if prompt exists
    if (currentPrompt) {
      promptInput.value = currentPrompt + ', ' + term;
    } else {
      promptInput.value = term;
    }

    // Update token count and chip states
    updateTokenCount();

    // Close dropdown after selection
    document.querySelectorAll('.tag-dropdown-menu').forEach(d => d.classList.add('hidden'));
    document.querySelectorAll('.tag-dropdown-btn').forEach(b => b.classList.remove('active'));

    // Focus back on input
    promptInput.focus();
  }

  // Update chip active states based on current prompt
  function updateChipStates() {
    const promptInput = document.getElementById('prompt-input');
    if (!promptInput) return;

    const promptLower = promptInput.value.toLowerCase();
    const chips = document.querySelectorAll('.suggestion-chip');

    chips.forEach(chip => {
      const term = chip.getAttribute('data-term');
      if (term && promptLower.includes(term.toLowerCase())) {
        chip.classList.add('active');
      } else {
        chip.classList.remove('active');
      }
    });
  }

  // Toggle tag dropdown - opens one, closes others
  function toggleTagDropdown(category) {
    const dropdown = document.getElementById(`dropdown-${category}`);
    const btn = dropdown.previousElementSibling;
    const allDropdowns = document.querySelectorAll('.tag-dropdown-menu');
    const allBtns = document.querySelectorAll('.tag-dropdown-btn');

    // Close all dropdowns first
    allDropdowns.forEach(d => {
      if (d.id !== `dropdown-${category}`) {
        d.classList.add('hidden');
      }
    });
    allBtns.forEach(b => {
      if (b !== btn) {
        b.classList.remove('active');
      }
    });

    // Toggle the clicked one
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      btn.classList.add('active');
    } else {
      dropdown.classList.add('hidden');
      btn.classList.remove('active');
    }
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.tag-dropdown')) {
      document.querySelectorAll('.tag-dropdown-menu').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.tag-dropdown-btn').forEach(b => b.classList.remove('active'));
    }
  });

  // Keyboard shortcuts for prompt bar
  document.addEventListener('DOMContentLoaded', function() {
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-btn');
    const form = document.getElementById('generate-form');

    // Initialize token count and chip states on page load
    updateTokenCount();

    // Show toast on form submit
    form.addEventListener('submit', function(e) {
      const promptText = promptInput.value.trim();
      if (promptText && typeof showInfoToast === 'function') {
        showInfoToast('Generation Started', promptText.substring(0, 40) + (promptText.length > 40 ? '...' : ''));
      }
    });

    // Cmd/Ctrl + Enter to generate
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        if (promptInput.value.trim() && !generateBtn.disabled) {
          form.submit();
        }
      }

      // Cmd/Ctrl + K to focus prompt
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        promptInput.focus();
        promptInput.select();
      }

      // Escape to blur
      if (e.key === 'Escape' && document.activeElement === promptInput) {
        promptInput.blur();
      }
    });

    // Submit on Enter (without Cmd) when input is focused
    promptInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        if (this.value.trim() && !generateBtn.disabled) {
          form.submit();
        }
      }
    });
  });
  // Improve prompt - calls backend enhancer and shows comparison modal
  async function improvePrompt() {
    const promptInput = document.getElementById('prompt-input');
    const modelKeyInput = document.getElementById('model_key_input');
    const improveBtn = document.getElementById('improve-btn');

    const prompt = promptInput.value.trim();
    if (!prompt) {
      if (typeof showWarningToast === 'function') {
        showWarningToast('No Prompt', 'Enter a prompt first to improve it');
      }
      return;
    }

    // Show loading state
    improveBtn.disabled = true;
    improveBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

    try {
      const response = await fetch('/images/enhance_prompt', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          prompt: prompt,
          model_key: modelKeyInput.value || 'sd-v1-5'
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to enhance prompt');
      }

      if (data.was_enhanced) {
        showEnhanceModal(data.original, data.enhanced, data.analysis);
      } else {
        if (typeof showInfoToast === 'function') {
          showInfoToast('Already Good', 'Your prompt looks great as is!');
        }
      }
    } catch (error) {
      console.error('Enhance prompt error:', error);
      if (typeof showErrorToast === 'function') {
        showErrorToast('Enhancement Failed', error.message);
      }
    } finally {
      // Restore button
      improveBtn.disabled = false;
      improveBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg><span>Improve</span>';
    }
  }

  // Show the enhance comparison modal
  function showEnhanceModal(original, enhanced, analysis) {
    // Remove existing modal if any
    const existingModal = document.getElementById('enhance-modal');
    if (existingModal) existingModal.remove();

    // Build suggestions list
    let suggestionsHtml = '';
    if (analysis && analysis.suggestions && analysis.suggestions.length > 0) {
      suggestionsHtml = '<div class="mt-3 pt-3 border-t" style="border-color: hsl(var(--border));"><p class="text-xs font-medium mb-2" style="color: hsl(var(--muted-foreground));">Added:</p><ul class="space-y-1">';
      analysis.suggestions.forEach(s => {
        suggestionsHtml += `<li class="text-xs flex items-center gap-1.5" style="color: hsl(var(--muted-foreground));"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--primary));"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${s}</li>`;
      });
      suggestionsHtml += '</ul></div>';
    }

    const modal = document.createElement('div');
    modal.id = 'enhance-modal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="absolute inset-0 bg-black/60" onclick="closeEnhanceModal()"></div>
      <div class="relative max-w-lg w-full rounded-xl border shadow-2xl p-5" style="background-color: hsl(var(--card)); border-color: hsl(var(--border));">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--primary));">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
            <h3 class="text-lg font-semibold" style="color: hsl(var(--foreground));">Enhanced Prompt</h3>
          </div>
          <button onclick="closeEnhanceModal()" class="p-1.5 rounded-full hover:bg-white/10 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--muted-foreground));">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-xs font-medium mb-1.5 block" style="color: hsl(var(--muted-foreground));">Original</label>
            <div class="p-3 rounded-lg text-sm" style="background-color: hsl(var(--muted) / 0.3); color: hsl(var(--foreground));">${escapeHtml(original)}</div>
          </div>

          <div class="flex items-center justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--primary));">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
          </div>

          <div>
            <label class="text-xs font-medium mb-1.5 block" style="color: hsl(var(--muted-foreground));">Enhanced</label>
            <div class="p-3 rounded-lg text-sm border-2" style="background-color: hsl(var(--primary) / 0.1); border-color: hsl(var(--primary) / 0.3); color: hsl(var(--foreground));">${escapeHtml(enhanced)}</div>
          </div>

          ${suggestionsHtml}
        </div>

        <div class="flex gap-3 mt-5">
          <button onclick="closeEnhanceModal()" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors border" style="border-color: hsl(var(--border)); color: hsl(var(--foreground));">
            Keep Original
          </button>
          <button onclick="applyEnhancedPrompt('${escapeHtml(enhanced).replace(/'/g, "\\'")}')" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors dw-btn-primary">
            Apply Enhanced
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Focus trap
    modal.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEnhanceModal();
      }
    });
  }

  // Close enhance modal
  function closeEnhanceModal() {
    const modal = document.getElementById('enhance-modal');
    if (modal) modal.remove();
  }

  // Apply the enhanced prompt
  function applyEnhancedPrompt(enhanced) {
    const promptInput = document.getElementById('prompt-input');
    promptInput.value = enhanced;
    updateTokenCount();
    closeEnhanceModal();

    if (typeof showSuccessToast === 'function') {
      showSuccessToast('Prompt Enhanced', 'Quality keywords added to your prompt');
    }

    // Focus back on input
    promptInput.focus();
  }

  // Escape HTML for safe insertion
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
