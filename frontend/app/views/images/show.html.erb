<%# Phase 3: Enhanced Image Detail View with Midjourney-style Metadata Panel %>

<div class="min-h-screen flex flex-col" style="background-color: hsl(var(--background));">
  <%# Header with back button %>
  <div class="flex items-center justify-between px-4 py-3 border-b" style="border-color: hsl(var(--border));">
    <%= link_to images_path, class: "inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-white/5", style: "color: hsl(var(--muted-foreground));" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Gallery
    <% end %>

    <div class="flex items-center gap-2">
      <%# Quick actions in header %>
      <% if @image.completed? && @image.image_url.present? %>
        <button onclick="downloadCurrentImage()"
                class="p-2 rounded-lg transition-colors hover:bg-white/10"
                style="color: hsl(var(--muted-foreground));"
                title="Download">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
        </button>
      <% end %>
    </div>
  </div>

  <%# Main content area %>
  <div class="flex-1 flex overflow-hidden">
    <%# Image Display Area (flex-1) %>
    <div class="flex-1 flex items-center justify-center p-6 overflow-hidden">
      <% if @image.completed? && @image.image_url.present? %>
        <div class="relative max-w-full max-h-full">
          <%= image_tag @image.image_url,
              alt: @image.prompt,
              class: "max-w-full max-h-[calc(100vh-120px)] w-auto h-auto rounded-lg shadow-2xl object-contain",
              id: "main-image" %>
        </div>
      <% elsif @image.failed? %>
        <div class="w-full max-w-md p-8 rounded-xl text-center" style="background-color: hsl(var(--destructive) / 0.1);">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" style="background-color: hsl(var(--destructive) / 0.2);">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: hsl(var(--destructive));">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <p class="text-lg font-semibold mb-2" style="color: hsl(var(--destructive));">Generation Failed</p>
          <p class="text-sm mb-4" style="color: hsl(var(--muted-foreground));">
            <%= @image.metadata&.dig('error') || 'An error occurred during generation' %>
          </p>
          <button onclick="retryGeneration(<%= @image.id %>)"
                  class="px-4 py-2 rounded-lg font-medium transition-colors"
                  style="background-color: hsl(var(--destructive)); color: white;">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Retry Generation
          </button>
        </div>
      <% else %>
        <%# Processing/Generating State %>
        <div class="w-full max-w-md p-8 rounded-xl text-center" style="background-color: hsl(var(--card));">
          <div class="relative w-20 h-20 mx-auto mb-4">
            <div class="w-20 h-20 border-4 border-t-transparent rounded-full animate-spin"
                 style="border-color: hsl(var(--primary)); border-top-color: transparent;"></div>
          </div>
          <p class="text-lg font-semibold mb-1" style="color: hsl(var(--primary));">
            <%= @image.status_display %>
          </p>
          <p class="text-sm" style="color: hsl(var(--muted-foreground));">
            This may take 1-3 minutes...
          </p>
        </div>
      <% end %>
    </div>

    <%# Metadata Panel (320px fixed width) %>
    <aside class="w-80 flex-shrink-0 border-l overflow-y-auto" style="background-color: hsl(var(--card)); border-color: hsl(var(--border));">
      <div class="p-4 space-y-4">

        <%# Model Badge %>
        <div class="flex items-center gap-2">
          <% model_display = case @image.model_key
             when 'sd-v1-5' then { name: 'SD v1.5', color: 'primary' }
             when 'openjourney' then { name: 'OpenJourney', color: 'success' }
             when 'sdxl' then { name: 'SDXL', color: 'warning' }
             else { name: @image.model_key || 'SD v1.5', color: 'primary' }
             end %>
          <div class="px-3 py-1 rounded-full text-xs font-semibold"
               style="background-color: hsl(var(--<%= model_display[:color] %>) / 0.2); color: hsl(var(--<%= model_display[:color] %>));">
            <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <%= model_display[:name] %>
          </div>

          <%# Generation type badge %>
          <% if @image.generation_type_image_to_image? %>
            <div class="px-2 py-1 rounded-full text-xs font-medium"
                 style="background-color: hsl(var(--accent)); color: hsl(var(--accent-foreground));">
              img2img
            </div>
          <% end %>
        </div>

        <%# Status %>
        <div class="flex items-center justify-between py-2 border-b" style="border-color: hsl(var(--border));">
          <span class="text-xs uppercase tracking-wide" style="color: hsl(var(--muted-foreground));">Status</span>
          <span class="px-2 py-0.5 rounded text-xs font-medium
            <%= case @image.status
                when 'completed' then 'bg-green-500/20 text-green-400'
                when 'failed' then 'bg-red-500/20 text-red-400'
                when 'processing' then 'bg-cyan-500/20 text-cyan-400'
                else 'bg-yellow-500/20 text-yellow-400'
                end %>">
            <%= @image.status_display %>
          </span>
        </div>

        <%# Prompt Section %>
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs uppercase tracking-wide" style="color: hsl(var(--muted-foreground));">Prompt</span>
            <button onclick="copyPrompt()"
                    class="p-1 rounded transition-colors hover:bg-white/10"
                    style="color: hsl(var(--muted-foreground));"
                    title="Copy prompt">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          <p id="prompt-text" class="text-sm leading-relaxed p-3 rounded-lg"
             style="background-color: hsl(var(--background)); color: hsl(var(--foreground));">
            <%= @image.prompt %>
          </p>
        </div>

        <%# Negative Prompt %>
        <% if @image.negative_prompt.present? %>
          <div>
            <span class="text-xs uppercase tracking-wide" style="color: hsl(var(--muted-foreground));">Negative Prompt</span>
            <p class="text-xs mt-2 p-2 rounded-lg"
               style="background-color: hsl(var(--background)); color: hsl(var(--muted-foreground));">
              <%= @image.negative_prompt %>
            </p>
          </div>
        <% end %>

        <%# Settings Grid %>
        <div>
          <span class="text-xs uppercase tracking-wide mb-2 block" style="color: hsl(var(--muted-foreground));">Settings</span>
          <div class="grid grid-cols-2 gap-2">
            <%# Dimensions %>
            <div class="p-2 rounded-lg" style="background-color: hsl(var(--background));">
              <p class="text-xs" style="color: hsl(var(--muted-foreground));">Size</p>
              <p class="text-sm font-mono font-medium" style="color: hsl(var(--foreground));">
                <%= @image.width || 512 %>Ã—<%= @image.height || 512 %>
              </p>
            </div>

            <%# Steps %>
            <div class="p-2 rounded-lg" style="background-color: hsl(var(--background));">
              <p class="text-xs" style="color: hsl(var(--muted-foreground));">Steps</p>
              <p class="text-sm font-mono font-medium" style="color: hsl(var(--foreground));">
                <%= @image.num_inference_steps || 30 %>
              </p>
            </div>

            <%# Guidance %>
            <div class="p-2 rounded-lg" style="background-color: hsl(var(--background));">
              <p class="text-xs" style="color: hsl(var(--muted-foreground));">Guidance</p>
              <p class="text-sm font-mono font-medium" style="color: hsl(var(--foreground));">
                <%= @image.guidance_scale || 7.5 %>
              </p>
            </div>

            <%# Seed %>
            <div class="p-2 rounded-lg" style="background-color: hsl(var(--background));">
              <p class="text-xs" style="color: hsl(var(--muted-foreground));">Seed</p>
              <p class="text-sm font-mono font-medium" style="color: hsl(var(--foreground));">
                <%= @image.seed || 'Random' %>
              </p>
            </div>

            <%# Strength (img2img only) %>
            <% if @image.generation_type_image_to_image? && @image.strength.present? %>
              <div class="p-2 rounded-lg col-span-2" style="background-color: hsl(var(--background));">
                <p class="text-xs" style="color: hsl(var(--muted-foreground));">Strength</p>
                <p class="text-sm font-mono font-medium" style="color: hsl(var(--foreground));">
                  <%= @image.strength %>
                </p>
              </div>
            <% end %>
          </div>
        </div>

        <%# Timestamp %>
        <div class="pt-2 border-t" style="border-color: hsl(var(--border));">
          <div class="flex items-center gap-2 text-xs" style="color: hsl(var(--muted-foreground));">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Generated <%= time_ago_in_words(@image.created_at) %> ago</span>
          </div>
          <% if @image.generation_time && @image.generation_time > 0 %>
            <p class="text-xs mt-1" style="color: hsl(var(--muted-foreground));">
              Took <%= @image.generation_time.round(1) %>s
            </p>
          <% end %>
        </div>

        <%# Action Buttons %>
        <div class="pt-4 space-y-2">
          <% if @image.completed? && @image.image_url.present? %>
            <%# Download Button %>
            <button onclick="downloadCurrentImage()"
                    class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg font-medium transition-colors"
                    style="background-color: hsl(var(--primary)); color: hsl(var(--primary-foreground));">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              Download
            </button>
          <% end %>

          <%# Secondary Actions Row %>
          <div class="grid grid-cols-2 gap-2">
            <%# Copy Prompt %>
            <button onclick="copyPrompt()"
                    class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                    style="background-color: hsl(var(--secondary)); color: hsl(var(--secondary-foreground));">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              Copy
            </button>

            <%# Remix %>
            <button onclick="remixImage()"
                    class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                    style="background-color: hsl(var(--secondary)); color: hsl(var(--secondary-foreground));">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Remix
            </button>
          </div>

          <%# Delete Button %>
          <button onclick="confirmDelete()"
                  class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-red-500/20"
                  style="color: hsl(var(--destructive));">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete Image
          </button>
        </div>
      </div>
    </aside>
  </div>
</div>

<%# Hidden form for delete %>
<%= form_with url: image_path(@image), method: :delete, id: "delete-form", local: true do %>
<% end %>

<script>
  const imageData = {
    id: <%= @image.id %>,
    prompt: `<%= j @image.prompt %>`,
    imageUrl: `<%= @image.image_url || '' %>`,
    csrfToken: document.querySelector('meta[name="csrf-token"]')?.content
  };

  function downloadCurrentImage() {
    if (!imageData.imageUrl) return;

    fetch(imageData.imageUrl)
      .then(response => response.blob())
      .then(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `dragon-wings-${imageData.id}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      })
      .catch(err => {
        console.error('Download failed:', err);
        // Fallback: open in new tab
        window.open(imageData.imageUrl, '_blank');
      });
  }

  function copyPrompt() {
    navigator.clipboard.writeText(imageData.prompt).then(() => {
      // Show brief confirmation
      const btn = event.currentTarget;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!';
      btn.style.color = 'hsl(var(--success))';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.color = '';
      }, 1500);
    }).catch(err => {
      console.error('Copy failed:', err);
      alert('Failed to copy prompt');
    });
  }

  function remixImage() {
    // Navigate to gallery with prompt pre-filled
    const url = new URL('/images', window.location.origin);
    url.searchParams.set('remix', imageData.id);
    url.searchParams.set('prompt', imageData.prompt);
    window.location.href = url.toString();
  }

  function confirmDelete() {
    if (confirm('Are you sure you want to delete this image? This cannot be undone.')) {
      document.getElementById('delete-form').submit();
    }
  }

  function retryGeneration(imageId) {
    if (!confirm('Retry this generation?')) return;

    fetch(`/images/${imageId}/retry`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': imageData.csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        window.location.reload();
      } else {
        alert('Failed to retry generation. Please try again.');
      }
    })
    .catch(err => {
      console.error('Retry failed:', err);
      alert('Failed to retry generation. Please try again.');
    });
  }

  <% unless @image.generation_complete? %>
  // Auto-refresh for pending/processing images
  document.addEventListener('DOMContentLoaded', function() {
    const pollInterval = setInterval(function() {
      fetch(`/images/${imageData.id}/status`)
        .then(response => response.json())
        .then(data => {
          if (data.generation_complete) {
            window.location.reload();
          }
        })
        .catch(error => console.error('Status check failed:', error));
    }, 3000);
  });
  <% end %>
</script>
